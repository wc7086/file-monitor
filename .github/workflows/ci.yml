name: ğŸ”„ Continuous Integration

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ğŸ§ª åŸºç¡€æµ‹è¯•å’Œä»£ç è´¨é‡æ£€æŸ¥
  test:
    name: ğŸ§ª Test Suite
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        rust: [stable, beta, nightly]
        exclude:
          # å‡å°‘ nightly ç‰ˆæœ¬çš„æµ‹è¯•çŸ©é˜µ
          - os: windows-latest
            rust: nightly
          - os: macos-latest
            rust: nightly
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ¦€ Install Rust toolchain
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: ${{ matrix.rust }}
        components: rustfmt, clippy
    
    - name: ğŸ“¦ Cache Cargo dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-${{ matrix.rust }}-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-${{ matrix.rust }}-
          ${{ runner.os }}-cargo-
    
    - name: ğŸ” Check code formatting
      if: matrix.rust == 'stable' && matrix.os == 'ubuntu-latest'
      run: cargo fmt --all -- --check
    
    - name: ğŸ“ Run Clippy lints
      if: matrix.rust == 'stable'
      run: cargo clippy --all-targets --all-features -- -D warnings
    
    - name: ğŸ”¨ Build project
      run: cargo build --verbose --all-features
    
    - name: ğŸ§ª Run unit tests
      run: cargo test --verbose --all-features
    
    - name: ğŸ“š Test documentation
      if: matrix.rust == 'stable' && matrix.os == 'ubuntu-latest'
      run: cargo doc --no-deps --all-features

  # ğŸ—ï¸ é›†æˆæµ‹è¯•
  integration-tests:
    name: ğŸ—ï¸ Integration Tests
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ¦€ Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
    
    - name: ğŸ“¦ Cache Cargo dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-integration-${{ hashFiles('**/Cargo.lock') }}
    
    - name: ğŸ”¨ Build release version
      run: cargo build --release
    
    - name: ğŸ§ª Run integration tests
      run: cargo test --test integration_tests --release -- --test-threads=1
    
    - name: ğŸ¯ Test CLI functionality
      shell: bash
      run: |
        # åˆ›å»ºæµ‹è¯•ç›®å½•ç»“æ„
        mkdir -p test_cli/{a,b,c}
        echo "test file" > test_cli/a/test.txt
        echo "test file" > test_cli/b/test.txt
        
        # æµ‹è¯•éäº¤äº’æ¨¡å¼
        cargo run --release -- --non-interactive --monitor-path test_cli --once
        
        # æµ‹è¯•é…ç½®æ–‡ä»¶åˆ›å»º
        if [ ! -f config.toml ]; then
          echo "âŒ é…ç½®æ–‡ä»¶æœªåˆ›å»º"
          exit 1
        fi
        
        echo "âœ… CLI åŠŸèƒ½æµ‹è¯•é€šè¿‡"
    
    - name: ğŸƒâ€â™‚ï¸ Test parallel modes
      shell: bash
      run: |
        # åˆ›å»ºå¤§é‡æµ‹è¯•æ–‡ä»¶
        mkdir -p stress_test
        for i in {1..100}; do
          mkdir -p "stress_test/dir_$i"
          for j in {1..10}; do
            echo "content $i-$j" > "stress_test/dir_$i/file_$j.txt"
          done
        done
        
        # æµ‹è¯•ä¸åŒå¹¶è¡Œæ¨¡å¼
        for mode in sync async parallel; do
          echo "æµ‹è¯•æ¨¡å¼: $mode"
          cargo run --release -- \
            --non-interactive \
            --monitor-path stress_test \
            --once
        done
        
        echo "âœ… å¹¶è¡Œæ¨¡å¼æµ‹è¯•é€šè¿‡"

  # ğŸš€ æ€§èƒ½åŸºå‡†æµ‹è¯•
  performance-tests:
    name: ğŸš€ Performance Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ¦€ Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
    
    - name: ğŸ“¦ Cache Cargo dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          target/
        key: ${{ runner.os }}-cargo-perf-${{ hashFiles('**/Cargo.lock') }}
    
    - name: ğŸ”¨ Build optimized release
      run: cargo build --release
    
    - name: âš¡ Run performance benchmarks
      run: |
        chmod +x scripts/performance_test.sh
        ./scripts/performance_test.sh
    
    - name: ğŸ“Š Upload performance results
      uses: actions/upload-artifact@v4
      with:
        name: performance-results
        path: performance_results.txt
        retention-days: 30

  # ğŸ›¡ï¸ å®‰å…¨æ€§æ‰«æ
  security-audit:
    name: ğŸ›¡ï¸ Security Audit
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ¦€ Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
    
    - name: ğŸ” Install cargo-audit
      run: cargo install cargo-audit
    
    - name: ğŸ›¡ï¸ Run security audit
      run: cargo audit
    
    - name: ğŸ” Run cargo-deny
      uses: EmbarkStudios/cargo-deny-action@v1

  # ğŸŒ è·¨å¹³å°å…¼å®¹æ€§æµ‹è¯•
  cross-platform:
    name: ğŸŒ Cross Platform Tests
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
          - os: windows-latest
            target: x86_64-pc-windows-msvc
          - os: macos-latest
            target: x86_64-apple-darwin
          - os: macos-latest
            target: aarch64-apple-darwin
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ¦€ Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target }}
    
    - name: ğŸ”¨ Build for target
      run: cargo build --release --target ${{ matrix.target }}
    
    - name: ğŸ§ª Test for target (if native)
      if: |
        (matrix.target == 'x86_64-unknown-linux-gnu' && matrix.os == 'ubuntu-latest') ||
        (matrix.target == 'x86_64-pc-windows-msvc' && matrix.os == 'windows-latest') ||
        (matrix.target == 'x86_64-apple-darwin' && matrix.os == 'macos-latest')
      run: cargo test --release --target ${{ matrix.target }}

  # ğŸ“ ä»£ç è¦†ç›–ç‡
  coverage:
    name: ğŸ“ Code Coverage
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ¦€ Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        components: llvm-tools-preview
    
    - name: ğŸ“¦ Install cargo-llvm-cov
      uses: taiki-e/install-action@cargo-llvm-cov
    
    - name: ğŸ“Š Generate code coverage
      run: cargo llvm-cov --all-features --workspace --lcov --output-path lcov.info
    
    - name: ğŸ“¤ Upload to codecov.io
      uses: codecov/codecov-action@v4
      with:
        files: lcov.info
        fail_ci_if_error: false

  # âœ… æ€»ä½“çŠ¶æ€æ£€æŸ¥
  ci-success:
    name: âœ… CI Success
    if: always()
    runs-on: ubuntu-latest
    needs:
      - test
      - integration-tests
      - security-audit
      - cross-platform
    
    steps:
    - name: âœ… Check all jobs
      if: |
        needs.test.result != 'success' ||
        needs.integration-tests.result != 'success' ||
        needs.security-audit.result != 'success' ||
        needs.cross-platform.result != 'success'
      run: |
        echo "âŒ ä¸€ä¸ªæˆ–å¤šä¸ª CI ä½œä¸šå¤±è´¥"
        exit 1
    
    - name: ğŸ‰ All checks passed
      run: echo "ğŸ‰ æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼" 