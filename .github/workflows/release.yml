name: ðŸš€ Release

on:
  release:
    types: [published]
  push:
    tags:
      - 'v*'

# æ·»åŠ å¿…è¦çš„æƒé™
permissions:
  contents: write
  packages: write
  id-token: write

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ðŸ—ï¸ æž„å»ºå¤šå¹³å°äºŒè¿›åˆ¶æ–‡ä»¶
  build-binaries:
    name: ðŸ—ï¸ Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          # Linux ç›®æ ‡
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            artifact_name: file_monitor
            asset_name: file_monitor-linux-x86_64
          - target: x86_64-unknown-linux-musl
            os: ubuntu-latest
            artifact_name: file_monitor
            asset_name: file_monitor-linux-x86_64-musl
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            artifact_name: file_monitor
            asset_name: file_monitor-linux-aarch64
          
          # Windows ç›®æ ‡
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            artifact_name: file_monitor.exe
            asset_name: file_monitor-windows-x86_64.exe
          - target: aarch64-pc-windows-msvc
            os: windows-latest
            artifact_name: file_monitor.exe
            asset_name: file_monitor-windows-aarch64.exe
          
          # macOS ç›®æ ‡
          - target: x86_64-apple-darwin
            os: macos-latest
            artifact_name: file_monitor
            asset_name: file_monitor-macos-x86_64
          - target: aarch64-apple-darwin
            os: macos-latest
            artifact_name: file_monitor
            asset_name: file_monitor-macos-aarch64

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ¦€ Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target }}

    - name: ðŸ“¦ Cache Rust toolchain
      uses: actions/cache@v4
      with:
        path: |
          ~/.rustup/toolchains
          ~/.rustup/update-hashes
          ~/.rustup/settings.toml
        key: ${{ runner.os }}-rustup-stable-${{ matrix.target }}-v3-${{ hashFiles('rust-toolchain.toml', 'rust-toolchain') }}
        restore-keys: |
          ${{ runner.os }}-rustup-stable-${{ matrix.target }}-v3-
          ${{ runner.os }}-rustup-stable-v3-

    - name: ðŸ“¦ Cache Cargo registry and index
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
        key: ${{ runner.os }}-cargo-registry-v2-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-registry-v2-

    - name: ðŸ“¦ Cache Cargo target directory
      uses: actions/cache@v4
      with:
        path: target/
        key: ${{ runner.os }}-cargo-target-release-${{ matrix.target }}-v2-${{ hashFiles('**/Cargo.lock') }}-${{ hashFiles('**/*.rs') }}
        restore-keys: |
          ${{ runner.os }}-cargo-target-release-${{ matrix.target }}-v2-${{ hashFiles('**/Cargo.lock') }}-
          ${{ runner.os }}-cargo-target-release-${{ matrix.target }}-v2-
          ${{ runner.os }}-cargo-target-release-v2-

    # Linux ç‰¹æ®Šä¾èµ–
    - name: ðŸ”§ Install Linux dependencies
      if: matrix.os == 'ubuntu-latest'
      shell: bash
      run: |
        sudo apt-get update
        sudo apt-get install -y musl-tools
        if [[ "${{ matrix.target }}" == "aarch64-unknown-linux-gnu" ]]; then
          # å®‰è£… ARM64 äº¤å‰ç¼–è¯‘å·¥å…·é“¾ï¼ˆåŒ…å« gcc å’Œ binutilsï¼‰
          sudo apt-get install -y gcc-aarch64-linux-gnu binutils-aarch64-linux-gnu
        fi

    # ä¸º ARM ç›®æ ‡è®¾ç½®é“¾æŽ¥å™¨
    - name: ðŸ”— Configure cross-compilation
      if: matrix.target == 'aarch64-unknown-linux-gnu'
      shell: bash
      run: |
        echo "é…ç½® ARM64 äº¤å‰ç¼–è¯‘..."
        mkdir -p ~/.cargo
        echo '[target.aarch64-unknown-linux-gnu]' >> ~/.cargo/config.toml
        echo 'linker = "aarch64-linux-gnu-gcc"' >> ~/.cargo/config.toml
        echo "é…ç½®æ–‡ä»¶å†…å®¹:"
        cat ~/.cargo/config.toml
        echo "éªŒè¯å·¥å…·é“¾:"
        which aarch64-linux-gnu-gcc || echo "âš ï¸ ARM64 ç¼–è¯‘å™¨æœªæ‰¾åˆ°"
        aarch64-linux-gnu-gcc --version || echo "âš ï¸ ARM64 ç¼–è¯‘å™¨ç‰ˆæœ¬æ£€æŸ¥å¤±è´¥"

    # ä¸º musl ç›®æ ‡è®¾ç½®é…ç½®
    - name: ðŸ”— Configure musl target
      if: matrix.target == 'x86_64-unknown-linux-musl'
      shell: bash
      run: |
        echo "é…ç½® musl é™æ€é“¾æŽ¥..."
        mkdir -p ~/.cargo
        echo '[target.x86_64-unknown-linux-musl]' >> ~/.cargo/config.toml
        echo 'rustflags = ["-C", "target-feature=+crt-static"]' >> ~/.cargo/config.toml
        echo "é…ç½®æ–‡ä»¶å†…å®¹:"
        cat ~/.cargo/config.toml

    # æ¸…ç†å’Œå‡†å¤‡ Rust ç›®æ ‡
    - name: ðŸ§¹ Prepare Rust target
      shell: bash
      run: |
        echo "å‡†å¤‡ Rust ç›®æ ‡: ${{ matrix.target }}"
        
        # æ£€æŸ¥å½“å‰çŠ¶æ€
        echo "å½“å‰å·²å®‰è£…çš„ç›®æ ‡:"
        rustup target list --installed
        
        # å¦‚æžœç›®æ ‡å·²å­˜åœ¨ï¼Œç›´æŽ¥è·³è¿‡å®‰è£…
        if rustup target list --installed | grep -q "${{ matrix.target }}"; then
          echo "âœ… ç›®æ ‡ ${{ matrix.target }} å·²å®‰è£…ï¼Œè·³è¿‡å®‰è£…æ­¥éª¤"
          exit 0
        fi
        
        # å®‰è£…ç›®æ ‡ï¼Œå¸¦æœ‰æ›´å½»åº•çš„æ¸…ç†æœºåˆ¶
        echo "å®‰è£…ç›®æ ‡: ${{ matrix.target }}"
        MAX_RETRIES=3
        
        for i in $(seq 1 $MAX_RETRIES); do
          echo "å°è¯• $i/$MAX_RETRIES ..."
          
          # å®‰è£…å‰å…ˆæ¸…ç†å¯èƒ½çš„æ®‹ç•™æ–‡ä»¶
          if [ $i -gt 1 ]; then
            echo "ðŸ§¹ æ‰§è¡Œå½»åº•æ¸…ç†..."
            
            # æ¸…ç†ç»„ä»¶
            rustup component remove rust-std-${{ matrix.target }} 2>/dev/null || true
            
            # æ¸…ç†ä¸‹è½½ç¼“å­˜
            if [ -d ~/.rustup/downloads ]; then
              echo "æ¸…ç†ä¸‹è½½ç¼“å­˜..."
              find ~/.rustup/downloads -name "*${{ matrix.target }}*" -delete 2>/dev/null || true
            fi
            
            # æ¸…ç†è§£åŽ‹ç¼“å­˜  
            if [ -d ~/.rustup/tmp ]; then
              echo "æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
              rm -rf ~/.rustup/tmp/* 2>/dev/null || true
            fi
            
            # å¼ºåˆ¶æ¸…ç†ç›®æ ‡ç›¸å…³çš„å·¥å…·é“¾æ–‡ä»¶
            if [ -d ~/.rustup/toolchains ]; then
              echo "æ¸…ç†å·¥å…·é“¾ä¸­çš„ç›®æ ‡æ–‡ä»¶..."
              find ~/.rustup/toolchains -path "*/${{ matrix.target }}/*" -delete 2>/dev/null || true
              find ~/.rustup/toolchains -name "*${{ matrix.target }}*" -delete 2>/dev/null || true
            fi
            
            # ç­‰å¾…ä¸€ä¸‹è®©æ–‡ä»¶ç³»ç»ŸåŒæ­¥
            sleep 3
          fi
          
          # å°è¯•å®‰è£…
          if rustup target add ${{ matrix.target }}; then
            echo "âœ… ç›®æ ‡å®‰è£…æˆåŠŸ"
            break
          else
            if [ $i -eq $MAX_RETRIES ]; then
              echo "âŒ ç›®æ ‡å®‰è£…å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æ–¹æ¡ˆ..."
              
              # å¤‡ç”¨æ–¹æ¡ˆï¼šæ£€æŸ¥æ˜¯å¦æ˜¯è·¨ç¼–è¯‘ç›®æ ‡ï¼Œå¯èƒ½ä¸éœ€è¦è¿™ä¸ªç›®æ ‡
              case "${{ matrix.target }}" in
                "x86_64-apple-darwin"|"aarch64-apple-darwin")
                  # macOS ç›®æ ‡ï¼Œæ£€æŸ¥å½“å‰ç³»ç»Ÿæž¶æž„
                  CURRENT_ARCH=$(uname -m)
                  if [[ "$CURRENT_ARCH" == "arm64" && "${{ matrix.target }}" == "x86_64-apple-darwin" ]]; then
                    echo "âš ï¸ åœ¨ ARM64 macOS ä¸Šæž„å»º x86_64 ç›®æ ‡å¯èƒ½éœ€è¦é¢å¤–é…ç½®"
                    echo "å°è¯•ä½¿ç”¨ cross-compilation æ ‡å¿—..."
                    exit 0  # è®©æž„å»ºæ­¥éª¤å°è¯•å¤„ç†
                  elif [[ "$CURRENT_ARCH" == "x86_64" && "${{ matrix.target }}" == "aarch64-apple-darwin" ]]; then
                    echo "âš ï¸ åœ¨ x86_64 macOS ä¸Šæž„å»º ARM64 ç›®æ ‡å¯èƒ½éœ€è¦é¢å¤–é…ç½®"
                    echo "å°è¯•ä½¿ç”¨ cross-compilation æ ‡å¿—..."
                    exit 0  # è®©æž„å»ºæ­¥éª¤å°è¯•å¤„ç†
                  fi
                  ;;
                *)
                  echo "âŒ æ— æ³•å®‰è£…ç›®æ ‡ ${{ matrix.target }}"
                  exit 1
                  ;;
              esac
              
              exit 1
            fi
            echo "âš ï¸ å®‰è£…å¤±è´¥ï¼Œæ¸…ç†åŽé‡è¯•..."
            sleep 2
          fi
        done

    - name: ðŸ”¨ Build release binary
      shell: bash
      run: |
        echo "å¼€å§‹æž„å»ºç›®æ ‡: ${{ matrix.target }}"
        echo "Rust ç‰ˆæœ¬:"
        rustc --version
        echo "Cargo ç‰ˆæœ¬:"
        cargo --version
        echo "å·²å®‰è£…çš„ç›®æ ‡:"
        rustup target list --installed
        echo ""
        
        # éªŒè¯ç›®æ ‡å¯ç”¨ï¼ˆæˆ–å°è¯•å³æ—¶å®‰è£…ï¼‰
        echo "éªŒè¯ç›®æ ‡: ${{ matrix.target }}"
        if ! rustup target list --installed | grep -q "${{ matrix.target }}"; then
          echo "âš ï¸ ç›®æ ‡æœªé¢„å®‰è£…ï¼Œå°è¯•å³æ—¶å®‰è£…..."
          if ! rustup target add ${{ matrix.target }}; then
            echo "âš ï¸ å³æ—¶å®‰è£…å¤±è´¥ï¼Œå°è¯•å¼ºåˆ¶æž„å»º..."
          fi
        fi
        
        # å¼€å§‹æž„å»º
        echo "æ‰§è¡Œæž„å»ºå‘½ä»¤: cargo build --release --target ${{ matrix.target }} --verbose"
        if ! cargo build --release --target ${{ matrix.target }} --verbose; then
          echo "âŒ æž„å»ºå¤±è´¥ï¼Œå°è¯•æ¸…ç†å¹¶é‡è¯•..."
          cargo clean
          
          # æœ€åŽä¸€æ¬¡å°è¯•ï¼šå¼ºåˆ¶å®‰è£…ç›®æ ‡ç„¶åŽæž„å»º
          echo "ðŸ”§ æœ€åŽå°è¯•ï¼šé‡æ–°å®‰è£…ç›®æ ‡..."
          rustup component remove rust-std-${{ matrix.target }} 2>/dev/null || true
          rustup target add ${{ matrix.target }} || echo "ç›®æ ‡å®‰è£…ä»ç„¶å¤±è´¥ï¼Œå°è¯•ç»§ç»­æž„å»º..."
          
          cargo build --release --target ${{ matrix.target }} --verbose
        fi

    - name: ðŸ“¦ Prepare binary
      shell: bash
      run: |
        cd target/${{ matrix.target }}/release
        if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
          # Windows ä¸éœ€è¦ strip
          cp ${{ matrix.artifact_name }} ${{ matrix.asset_name }}
        else
          cp ${{ matrix.artifact_name }} ${{ matrix.asset_name }}
          
          # æ ¹æ®ç›®æ ‡æž¶æž„é€‰æ‹©æ­£ç¡®çš„ strip å·¥å…·
          case "${{ matrix.target }}" in
            "aarch64-unknown-linux-gnu")
              # ARM64 Linux ä½¿ç”¨äº¤å‰ç¼–è¯‘å·¥å…·é“¾çš„ strip
              if command -v aarch64-linux-gnu-strip &> /dev/null; then
                aarch64-linux-gnu-strip ${{ matrix.asset_name }}
              else
                echo "âš ï¸ aarch64-linux-gnu-strip not found, skipping strip for ARM64"
              fi
              ;;
            "x86_64-unknown-linux-musl")
              # musl ç›®æ ‡å¯èƒ½éœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œä½†é€šå¸¸ç³»ç»Ÿ strip å¯ä»¥å·¥ä½œ
              strip ${{ matrix.asset_name }} || echo "âš ï¸ strip failed for musl target, continuing..."
              ;;
            *)
              # å…¶ä»– Linux ç›®æ ‡ä½¿ç”¨ç³»ç»Ÿ strip
              strip ${{ matrix.asset_name }}
              ;;
          esac
        fi

    - name: ðŸ“¤ Upload binary artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.asset_name }}
        path: target/${{ matrix.target }}/release/${{ matrix.asset_name }}
        retention-days: 1

    - name: ðŸ” Debug build output
      if: always()
      shell: bash
      run: |
        echo "=== æž„å»ºè°ƒè¯•ä¿¡æ¯ ==="
        echo "ç›®æ ‡: ${{ matrix.target }}"
        echo "æž„å»ºç›®å½•å†…å®¹:"
        ls -la target/${{ matrix.target }}/release/ || echo "æž„å»ºç›®å½•ä¸å­˜åœ¨"
        echo "æŸ¥æ‰¾äºŒè¿›åˆ¶æ–‡ä»¶:"
        find target/${{ matrix.target }}/release/ -name "${{ matrix.artifact_name }}" -o -name "${{ matrix.asset_name }}" 2>/dev/null || echo "æœªæ‰¾åˆ°é¢„æœŸæ–‡ä»¶"
        echo "æ‰€æœ‰æ–‡ä»¶åˆ—è¡¨:"
        find target/${{ matrix.target }}/release/ -type f 2>/dev/null || echo "æ— æ–‡ä»¶"
        echo "==================="

  # ðŸ“¦ åˆ›å»ºå‘å¸ƒåŒ…
  create-release-assets:
    name: ðŸ“¦ Create Release Assets
    runs-on: ubuntu-latest
    needs: build-binaries
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ“¦ Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: ðŸ“ Create release directory
      run: mkdir -p release

    - name: ðŸŽ Package binaries
      shell: bash
      run: |
        echo "=== è°ƒè¯•ä¿¡æ¯ ==="
        echo "å½“å‰ç›®å½•: $(pwd)"
        echo "artifacts ç›®å½•å†…å®¹:"
        ls -la artifacts/
        echo ""
        echo "å„ä¸ªå¹³å°æž„ä»¶è¯¦æƒ…:"
        for dir in artifacts/*/; do
          if [ -d "$dir" ]; then
            echo "ðŸ“ $(basename "$dir"):"
            ls -la "$dir"
            echo "æ–‡ä»¶ç±»åž‹æ£€æŸ¥:"
            find "$dir" -type f -exec file {} \;
            echo "---"
          fi
        done
        echo "==============="
        
        cd artifacts
        for dir in */; do
          if [ -d "$dir" ]; then
            binary_name=$(basename "$dir")
            echo "å¤„ç†ç›®å½•: $binary_name"
            echo "ç›®å½•å†…å®¹:"
            ls -la "$dir"
            
            # æŸ¥æ‰¾äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆæ”¹è¿›åŒ¹é…é€»è¾‘ï¼‰
            binary_file=""
            
            # é¦–å…ˆå°è¯•æŒ‰ç…§æ–‡ä»¶ååŒ¹é…
            if [[ "$binary_name" == *"windows"* ]]; then
              # Windows å¹³å°æŸ¥æ‰¾ .exe æ–‡ä»¶
              binary_file=$(find "$dir" -name "*.exe" -type f | head -1)
            else
              # Linux/macOS å¹³å°æŸ¥æ‰¾ç‰¹å®šåç§°çš„æ–‡ä»¶
              # å…ˆå°è¯•ç²¾ç¡®åŒ¹é…
              if [[ -f "$dir/$binary_name" ]]; then
                binary_file="$dir/$binary_name"
              elif [[ -f "$dir/file_monitor" ]]; then
                binary_file="$dir/file_monitor"
              else
                # æŸ¥æ‰¾æ‰€æœ‰æ–‡ä»¶ï¼ŒæŽ’é™¤å·²çŸ¥çš„éžäºŒè¿›åˆ¶æ–‡ä»¶
                binary_file=$(find "$dir" -type f ! -name "*.txt" ! -name "*.md" ! -name "*.toml" ! -name "*.json" | head -1)
              fi
            fi
            
            echo "æ£€æµ‹åˆ°çš„äºŒè¿›åˆ¶æ–‡ä»¶: $binary_file"
            
            if [[ -f "$binary_file" ]]; then
              echo "ðŸ“¦ æ‰“åŒ… $binary_name (æ–‡ä»¶: $binary_file)"
              
              # åˆ›å»ºåŒ…ç›®å½•
              package_dir="../release/${binary_name}"
              mkdir -p "$package_dir"
              
              # å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä¿æŒå¯æ‰§è¡Œæƒé™
              cp "$binary_file" "$package_dir/"
              chmod +x "$package_dir"/*
              
              # æ·»åŠ æ–‡æ¡£æ–‡ä»¶
              if [ -f "../README.md" ]; then
                cp ../README.md "$package_dir/"
              else
                echo "# File Monitor" > "$package_dir/README.md"
              fi
              
              if ls ../LICENSE* >/dev/null 2>&1; then
                cp ../LICENSE* "$package_dir/"
              else
                echo "MIT License" > "$package_dir/LICENSE"
              fi
              
              # åˆ›å»ºç¤ºä¾‹é…ç½®æ–‡ä»¶
              cat > "$package_dir/config.example.toml" << 'EOF'
        # æ–‡ä»¶ç›‘æŽ§é…ç½®ç¤ºä¾‹
        [monitor]
        # ç›‘æŽ§çš„æ ¹ç›®å½•è·¯å¾„
        root_path = "/path/to/monitor"
        # æ£€æŸ¥æ–°æ–‡ä»¶çš„æ—¶é—´èŒƒå›´ï¼ˆå°æ—¶ï¼‰
        check_hours = 3
        # æ‰«æé—´éš”ï¼ˆç§’ï¼‰
        scan_interval = 60
        # å¹¶è¡Œæ¨¡å¼ï¼ˆsync/async/parallelï¼‰
        parallel_mode = "sync"
        
        [output]
        # æœ‰æ–°æ–‡ä»¶æ—¶çš„æç¤ºä¿¡æ¯
        recording_message = "æ­£åœ¨å½•åˆ¶"
        # æ²¡æœ‰æ–°æ–‡ä»¶æ—¶çš„æç¤ºä¿¡æ¯
        not_recording_message = "æœªå½•åˆ¶"
        EOF
              
              # åˆ›å»ºåŽ‹ç¼©åŒ…
              cd "../release"
              if [[ "$binary_name" == *"windows"* ]]; then
                echo "åˆ›å»º ZIP åŽ‹ç¼©åŒ…: ${binary_name}.zip"
                zip -r "${binary_name}.zip" "${binary_name}/"
              else
                echo "åˆ›å»º TAR.GZ åŽ‹ç¼©åŒ…: ${binary_name}.tar.gz"
                tar -czf "${binary_name}.tar.gz" "${binary_name}/"
              fi
              cd "../artifacts"
            else
              echo "âš ï¸ åœ¨ç›®å½• $binary_name ä¸­æ‰¾ä¸åˆ°å¯æ‰§è¡Œæ–‡ä»¶"
              echo "ç›®å½•å†…å®¹è¯¦æƒ…:"
              find "$dir" -type f -ls
            fi
          fi
        done
        
        echo "=== æœ€ç»ˆ release ç›®å½•å†…å®¹ ==="
        ls -la ../release/
        echo "=========================="

    - name: ðŸ“Š Generate checksums
      shell: bash
      run: |
        cd release
        echo "ç”Ÿæˆæ ¡éªŒå’Œæ–‡ä»¶..."
        ls -la
        
        # åªä¸ºå­˜åœ¨çš„æ–‡ä»¶ç”Ÿæˆæ ¡éªŒå’Œ
        if ls *.tar.gz >/dev/null 2>&1 || ls *.zip >/dev/null 2>&1; then
          sha256sum *.tar.gz *.zip > checksums.txt 2>/dev/null || {
            # å¦‚æžœä¸Šé¢å¤±è´¥ï¼Œåˆ†åˆ«å¤„ç†ä¸åŒç±»åž‹çš„æ–‡ä»¶
            (ls *.tar.gz >/dev/null 2>&1 && sha256sum *.tar.gz > checksums.txt) || true
            (ls *.zip >/dev/null 2>&1 && sha256sum *.zip >> checksums.txt) || true
          }
          echo "æ ¡éªŒå’Œæ–‡ä»¶å†…å®¹:"
          cat checksums.txt
        else
          echo "âš ï¸ æ²¡æœ‰æ‰¾åˆ°åŽ‹ç¼©åŒ…æ–‡ä»¶"
          echo "å½“å‰ç›®å½•å†…å®¹:"
          ls -la
          # åˆ›å»ºç©ºçš„ checksums æ–‡ä»¶ä»¥é¿å…åŽç»­æ­¥éª¤å¤±è´¥
          touch checksums.txt
        fi

    - name: ðŸ“¤ Upload release assets
      uses: actions/upload-artifact@v4
      with:
        name: release-packages
        path: release/
        retention-days: 30

  # ðŸš€ å‘å¸ƒåˆ° GitHub Release
  github-release:
    name: ðŸš€ GitHub Release
    runs-on: ubuntu-latest
    needs: create-release-assets
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ“¦ Download release packages
      uses: actions/download-artifact@v4
      with:
        name: release-packages
        path: release

    - name: ðŸ” Debug release files
      shell: bash
      run: |
        echo "=== Release ç›®å½•è°ƒè¯•ä¿¡æ¯ ==="
        echo "å½“å‰ç›®å½•: $(pwd)"
        echo "Release ç›®å½•å†…å®¹:"
        ls -la release/
        echo "æŸ¥æ‰¾åŽ‹ç¼©åŒ…æ–‡ä»¶:"
        find release/ -name "*.tar.gz" -o -name "*.zip" | head -20
        echo "æ–‡ä»¶æƒé™æ£€æŸ¥:"
        find release/ -type f -ls | head -20
        echo "=========================="

    - name: ðŸ“ Extract version from tag
      id: version
      shell: bash
      run: |
        VERSION=${GITHUB_REF#refs/tags/}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"

    - name: ðŸ“„ Generate release notes
      id: release_notes
      shell: bash
      run: |
        cat > release_notes.md << 'EOF'
        ## ðŸŽ‰ File Monitor ${{ steps.version.outputs.version }}
        
        ### âœ¨ åŠŸèƒ½ç‰¹æ€§
        - ðŸ” å¤šç›®å½•æ–‡ä»¶ç›‘æŽ§
        - âš¡ ä¸‰ç§å¹¶è¡Œæ¨¡å¼ï¼ˆsync/async/parallelï¼‰
        - ðŸŒ è·¨å¹³å°æ”¯æŒï¼ˆWindows/Linux/macOSï¼‰
        - ðŸ“Š æ€§èƒ½ä¼˜åŒ–å’Œç½‘ç»œæ–‡ä»¶ç³»ç»Ÿæ”¯æŒ
        - ðŸ”§ çµæ´»çš„é…ç½®é€‰é¡¹
        
        ### ðŸ“¦ æ”¯æŒå¹³å°
        - **Linux**: x86_64, aarch64 (GNU/musl)
        - **Windows**: x86_64, aarch64
        - **macOS**: x86_64 (Intel), aarch64 (Apple Silicon)
        
        ### ðŸš€ å¿«é€Ÿå¼€å§‹
        1. ä¸‹è½½å¯¹åº”å¹³å°çš„äºŒè¿›åˆ¶æ–‡ä»¶
        2. è§£åŽ‹åˆ°ç›®æ ‡ç›®å½•
        3. è¿è¡Œ `./file_monitor --help` æŸ¥çœ‹ä½¿ç”¨æ–¹æ³•
        
        ### ðŸ“‹ ä½¿ç”¨ç¤ºä¾‹
        ```bash
        # äº¤äº’å¼é…ç½®
        ./file_monitor
        
        # éžäº¤äº’å¼æ¨¡å¼
        ./file_monitor --non-interactive --monitor-path /path/to/monitor
        
        # è¿è¡Œä¸€æ¬¡æ£€æŸ¥
        ./file_monitor --once
        ```